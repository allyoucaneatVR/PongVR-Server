var VROne={};"undefined"!=typeof module&&(module.exports=VROne),"undefined"==typeof navigator&&(navigator={}),VROne.EngineMath={degToRad:function(e){return e*Math.PI/180}},VROne.Vector3=function(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0},VROne.Vector3.prototype={getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return 0!==e&&(this.x/=e,this.y/=e,this.z/=e),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},nullVector:function(){return this.x=0,this.y=0,this.z=0,this},scaleBy:function(e){return this.x*=e,this.y*=e,this.z*=e,this},set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},add:function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this},subtract:function(e,t,i){return this.x-=e,this.y-=t,this.z-=i,this},multiply:function(e,t,i){return this.x*=e,this.y*=t,this.z*=i,this},distance:function(e,t){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z;return Math.sqrt(i*i+r*r+n*n)},dotProduct:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},crossProduct:function(e){return new VROne.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},addVector3:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},copyToVector:function(e,t){t.x=e.x,t.y=e.y,t.z=e.z},copy:function(){return new VROne.Vector3(this.x,this.y,this.z)}},VROne.Quaternion=function(e,t,i,r){this.x=e||0,this.y=t||0,this.z=i||0,this.w=r||1},VROne.Quaternion.prototype={multiply:function(e,t){var i=e.w,r=e.x,n=e.y,a=e.z,o=t.w,s=t.x,h=t.y,l=t.z;return this.w=i*o-r*s-n*h-a*l,this.x=i*s+r*o+n*l-a*h,this.y=i*h-r*l+n*o+a*s,this.z=i*l+r*h-n*s+a*o,this},set:function(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r},fromAxisAngle:function(e,t){e.normalize();var i=Math.sin(t/2),r=Math.cos(t/2);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=r,this.normalize()},fromEulerAngles:function(e,t,i){var r=.5*e,n=.5*t,a=.5*i,o=Math.cos(r),s=Math.sin(r),h=Math.cos(n),l=Math.sin(n),u=Math.cos(a),d=Math.sin(a);this.w=o*h*u+s*l*d,this.x=s*h*u-o*l*d,this.y=o*l*u+s*h*d,this.z=o*h*d-s*l*u},normalize:function(){var e=this.x,t=this.y,i=this.z,r=this.w,n=1/Math.sqrt(e*e+t*t+i*i+r*r);return this.x*=n,this.y*=n,this.z*=n,this.w*=n,this},reset:function(){this.x=0,this.y=0,this.z=0,this.w=1},rotatePoint:function(e){var t=this.x,i=this.y,r=this.z,n=this.w,a=e.x,o=e.y,s=e.z,h=-t*a-i*o-r*s,l=n*a+i*s-r*o,u=n*o-t*s+r*a,d=n*s+t*o-i*a;return e.x=-h*t+l*n-u*r+d*i,e.y=-h*i+l*r+u*n-d*t,e.z=-h*r-l*i+u*t+d*n,e},getRotatedPoint:function(e){var t,i,r,n,a=this.x,o=this.y,s=this.z,h=this.w,l=e.x,u=e.y,d=e.z;n=-a*l-o*u-s*d,t=h*l+o*d-s*u,i=h*u-a*d+s*l,r=h*d+a*u-o*l;var c=new VROne.Vector3;return c.x=-n*a+t*h-i*s+r*o,c.y=-n*o+t*s+i*h-r*a,c.z=-n*s-t*o+i*a+r*h,c},toRotationMatrix:function(e){var t=this.x,i=this.y,r=this.z,n=this.w,a=t*t,o=t*i,s=t*r,h=t*n,l=i*i,u=i*r,d=i*n,c=r*r,p=r*n;e.data[0]=1-2*(l+c),e.data[1]=2*(o-p),e.data[2]=2*(s+d),e.data[4]=2*(o+p),e.data[5]=1-2*(a+c),e.data[6]=2*(u-h),e.data[8]=2*(s-d),e.data[9]=2*(u+h),e.data[10]=1-2*(a+l),e.data[3]=e.data[7]=e.data[11]=e.data[12]=e.data[13]=e.data[14]=0,e.data[15]=1},getConjugate:function(){return this.normalize(),new VROne.Quaternion(-this.x,-this.y,-this.z,this.w)},copy:function(){return new VROne.Quaternion(this.x,this.y,this.z,this.w)},copyToQuaternion:function(e,t){t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w}},VROne.Matrix4=function(){this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},VROne.Matrix4.makePerspective=function(e,t,i,r){var n=new VROne.Matrix4,a=e/2*Math.PI/180,o=Math.sin(a),s=Math.cos(a)/o,h=!0,l=h?-1:1;return n.data=new Float32Array([s/t,0,0,0,0,s,0,0,0,0,r/(i-r)*-l,l,0,0,r*i/(i-r),0]),n},VROne.Matrix4.makeOrthoPerspective=function(e,t,i,r,n,a){var o=new VROne.Matrix4,s=1/(e-t),h=1/(r-i),l=1/(n-a);return o.data=new Float32Array([-2*s,0,0,0,0,-2*h,0,0,0,0,2*l,0,(e+t)*s,(i+r)*h,(a+n)*l,1]),o},VROne.Matrix4.makeVRPerspective=function(e,t,i){var r=Math.PI/180,n=Math.tan(e.upDegrees*r),a=Math.tan(e.downDegrees*r),o=Math.tan(e.leftDegrees*r),s=Math.tan(e.rightDegrees*r),h=2/(o+s),l=(o-s)*h*.5,u=2/(n+a),d=(n-a)*u*.5,c=!0,p=c?-1:1,f=new VROne.Matrix4;return f.data=new Float32Array([h,0,0,0,0,u,0,0,l*p,d*p,i/(t-i)*-p,p,0,0,i*t/(t-i),0]),f},VROne.Matrix4.prototype={poolMatrix:new VROne.Matrix4,poolVector3:new VROne.Vector3,identity:function(){this.data[0]=1,this.data[1]=0,this.data[2]=0,this.data[3]=0,this.data[4]=0,this.data[5]=1,this.data[6]=0,this.data[7]=0,this.data[8]=0,this.data[9]=0,this.data[10]=1,this.data[11]=0,this.data[12]=0,this.data[13]=0,this.data[14]=0,this.data[15]=1},append:function(e){var t=this.data[0],i=this.data[4],r=this.data[8],n=this.data[12],a=this.data[1],o=this.data[5],s=this.data[9],h=this.data[13],l=this.data[2],u=this.data[6],d=this.data[10],c=this.data[14],p=this.data[3],f=this.data[7],g=this.data[11],m=this.data[15],x=e.data[0],v=e.data[4],R=e.data[8],V=e.data[12],y=e.data[1],O=e.data[5],M=e.data[9],w=e.data[13],b=e.data[2],S=e.data[6],C=e.data[10],T=e.data[14],A=e.data[3],E=e.data[7],P=e.data[11],D=e.data[15];this.data[0]=t*x+a*v+l*R+p*V,this.data[1]=t*y+a*O+l*M+p*w,this.data[2]=t*b+a*S+l*C+p*T,this.data[3]=t*A+a*E+l*P+p*D,this.data[4]=i*x+o*v+u*R+f*V,this.data[5]=i*y+o*O+u*M+f*w,this.data[6]=i*b+o*S+u*C+f*T,this.data[7]=i*A+o*E+u*P+f*D,this.data[8]=r*x+s*v+d*R+g*V,this.data[9]=r*y+s*O+d*M+g*w,this.data[10]=r*b+s*S+d*C+g*T,this.data[11]=r*A+s*E+d*P+g*D,this.data[12]=n*x+h*v+c*R+m*V,this.data[13]=n*y+h*O+c*M+m*w,this.data[14]=n*b+h*S+c*C+m*T,this.data[15]=n*A+h*E+c*P+m*D},appendRotation:function(e,t,i){if(this.poolMatrix.data[0]=1,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=1,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=1,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.getAxisRotation(t.x,t.y,t.z,e,this.poolMatrix),void 0!==i){var r=i;this.poolMatrix.appendTranslation(r.x,r.y,r.z)}this.append(this.poolMatrix)},appendScale:function(e,t,i){this.poolMatrix.data[0]=e,this.poolMatrix.data[1]=0,this.poolMatrix.data[2]=0,this.poolMatrix.data[3]=0,this.poolMatrix.data[4]=0,this.poolMatrix.data[5]=t,this.poolMatrix.data[6]=0,this.poolMatrix.data[7]=0,this.poolMatrix.data[8]=0,this.poolMatrix.data[9]=0,this.poolMatrix.data[10]=i,this.poolMatrix.data[11]=0,this.poolMatrix.data[12]=0,this.poolMatrix.data[13]=0,this.poolMatrix.data[14]=0,this.poolMatrix.data[15]=1,this.append(this.poolMatrix)},appendTranslation:function(e,t,i){this.data[12]+=e,this.data[13]+=t,this.data[14]+=i},getAxisRotation:function(e,t,i,r,n){var a;a=n?n:new VROne.Matrix4;var o=this.poolVector3;o.x=e,o.y=t,o.z=i;var s=-r*(Math.PI/180),h=Math.cos(s),l=Math.sin(s),u=1-h;a.data[0]=h+o.x*o.x*u,a.data[5]=h+o.y*o.y*u,a.data[10]=h+o.z*o.z*u;var d=o.x*o.y*u,c=o.z*l;return a.data[4]=d+c,a.data[1]=d-c,d=o.x*o.z*u,c=o.y*l,a.data[8]=d-c,a.data[2]=d+c,d=o.y*o.z*u,c=o.x*l,a.data[9]=d+c,a.data[6]=d-c,a},getDeterminant:function(){return 1*((this.data[0]*this.data[5]-this.data[4]*this.data[1])*(this.data[10]*this.data[15]-this.data[14]*this.data[11])-(this.data[0]*this.data[9]-this.data[8]*this.data[1])*(this.data[6]*this.data[15]-this.data[14]*this.data[7])+(this.data[0]*this.data[13]-this.data[12]*this.data[1])*(this.data[6]*this.data[11]-this.data[10]*this.data[7])+(this.data[4]*this.data[9]-this.data[8]*this.data[5])*(this.data[2]*this.data[15]-this.data[14]*this.data[3])-(this.data[4]*this.data[13]-this.data[12]*this.data[5])*(this.data[2]*this.data[11]-this.data[10]*this.data[3])+(this.data[8]*this.data[13]-this.data[12]*this.data[9])*(this.data[2]*this.data[7]-this.data[6]*this.data[3]))},transpose:function(){this.copyToMatrix(this,this.poolMatrix),this.data[1]=this.poolMatrix.data[4],this.data[2]=this.poolMatrix.data[8],this.data[3]=this.poolMatrix.data[12],this.data[4]=this.poolMatrix.data[1],this.data[6]=this.poolMatrix.data[9],this.data[7]=this.poolMatrix.data[13],this.data[8]=this.poolMatrix.data[2],this.data[9]=this.poolMatrix.data[6],this.data[11]=this.poolMatrix.data[14],this.data[12]=this.poolMatrix.data[3],this.data[13]=this.poolMatrix.data[7],this.data[14]=this.poolMatrix.data[11]},invert:function(){var e=this.getDeterminant(),t=Math.abs(e)>1e-11;if(!t)throw"Can't invert Matrix";e=1/e;var i=this.data[0],r=this.data[4],n=this.data[8],a=this.data[12],o=this.data[1],s=this.data[5],h=this.data[9],l=this.data[13],u=this.data[2],d=this.data[6],c=this.data[10],p=this.data[14],f=this.data[3],g=this.data[7],m=this.data[11],x=this.data[15];return this.data[0]=e*(s*(c*x-p*m)-h*(d*x-p*g)+l*(d*m-c*g)),this.data[1]=-e*(o*(c*x-p*m)-h*(u*x-p*f)+l*(u*m-c*f)),this.data[2]=e*(o*(d*x-p*g)-s*(u*x-p*f)+l*(u*g-d*f)),this.data[3]=-e*(o*(d*m-c*g)-s*(u*m-c*f)+h*(u*g-d*f)),this.data[4]=-e*(r*(c*x-p*m)-n*(d*x-p*g)+a*(d*m-c*g)),this.data[5]=e*(i*(c*x-p*m)-n*(u*x-p*f)+a*(u*m-c*f)),this.data[6]=-e*(i*(d*x-p*g)-r*(u*x-p*f)+a*(u*g-d*f)),this.data[7]=e*(i*(d*m-c*g)-r*(u*m-c*f)+n*(u*g-d*f)),this.data[8]=e*(r*(h*x-l*m)-n*(s*x-l*g)+a*(s*m-h*g)),this.data[9]=-e*(i*(h*x-l*m)-n*(o*x-l*f)+a*(o*m-h*f)),this.data[10]=e*(i*(s*x-l*g)-r*(o*x-l*f)+a*(o*g-s*f)),this.data[11]=-e*(i*(s*m-h*g)-r*(o*m-h*f)+n*(o*g-s*f)),this.data[12]=-e*(r*(h*p-l*c)-n*(s*p-l*d)+a*(s*c-h*d)),this.data[13]=e*(i*(h*p-l*c)-n*(o*p-l*u)+a*(o*c-h*u)),this.data[14]=-e*(i*(s*p-l*d)-r*(o*p-l*u)+a*(o*d-s*u)),this.data[15]=e*(i*(s*c-h*d)-r*(o*c-h*u)+n*(o*d-s*u)),t},transformVector:function(e){var t=e.x,i=e.y,r=e.z;return e.x=t*this.data[0]+i*this.data[4]+r*this.data[8]+this.data[12],e.y=t*this.data[1]+i*this.data[5]+r*this.data[9]+this.data[13],e.z=t*this.data[2]+i*this.data[6]+r*this.data[10]+this.data[14],e},copyToMatrix:function(e,t){t.data[0]=e.data[0],t.data[1]=e.data[1],t.data[2]=e.data[2],t.data[3]=e.data[3],t.data[4]=e.data[4],t.data[5]=e.data[5],t.data[6]=e.data[6],t.data[7]=e.data[7],t.data[8]=e.data[8],t.data[9]=e.data[9],t.data[10]=e.data[10],t.data[11]=e.data[11],t.data[12]=e.data[12],t.data[13]=e.data[13],t.data[14]=e.data[14],t.data[15]=e.data[15]},copy:function(){var e=new VROne.Matrix4;return e.data=new Float32Array(this.data),e},getMatrix3:function(e){var t;return t=e?e:new VROne.Matrix3,t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=this.data[2],t.data[3]=this.data[4],t.data[4]=this.data[5],t.data[5]=this.data[6],t.data[6]=this.data[8],t.data[7]=this.data[9],t.data[8]=this.data[10],t}},VROne.Matrix3=function(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1])},VROne.Matrix3.prototype={},VROne.Geometry=function(){this.position=new VROne.Vector3(0,0,0),this.rotation=new VROne.Quaternion,this.scale=new VROne.Vector3(1,1,1),this.offset=new VROne.Vector3(0,0,0)},VROne.Geometry.prototype={},VROne.Geometry.Box=function(e,t,i){VROne.Geometry.call(this),this.a=e||0,this.b=t||0,this.c=i||0},VROne.Geometry.Box.prototype=new VROne.Geometry,VROne.Geometry.Box.prototype.getO3D=function(e){var t=new VROne.Object3D,i=this.offset,r=this.a,n=this.b,a=this.c;return t.vertices=[],t.vertices.push(i.x+0,i.y+0,i.z+0),t.vertices.push(i.x+r,i.y+0,i.z+0),t.vertices.push(i.x+0,i.y+n,i.z+0),t.vertices.push(i.x+r,i.y+n,i.z+0),t.vertices.push(i.x+0,i.y+0,i.z+a),t.vertices.push(i.x+r,i.y+0,i.z+a),t.vertices.push(i.x+0,i.y+n,i.z+a),t.vertices.push(i.x+r,i.y+n,i.z+a),t.normals=[],t.normals.push(-1,-1,-1),t.normals.push(1,-1,-1),t.normals.push(-1,1,-1),t.normals.push(1,1,-1),t.normals.push(-1,-1,1),t.normals.push(1,-1,1),t.normals.push(-1,1,1),t.normals.push(1,1,1),t.indices=[],e?(t.indices.push(0,1),t.indices.push(5,1),t.indices.push(4,0),t.indices.push(4,5),t.indices.push(2,6),t.indices.push(6,7),t.indices.push(7,3),t.indices.push(3,2),t.indices.push(0,2),t.indices.push(4,6),t.indices.push(5,7),t.indices.push(3,1),t.isWireframe=!0):(t.indices.push(2,1,0),t.indices.push(2,3,1),t.indices.push(7,4,5),t.indices.push(7,6,4),t.indices.push(6,0,4),t.indices.push(6,2,0),t.indices.push(3,5,1),t.indices.push(3,7,5),t.indices.push(0,5,4),t.indices.push(0,1,5),t.indices.push(6,3,2),t.indices.push(6,7,3)),t.position=this.position,t.rotation=this.rotation,t.scale=this.scale,t},VROne.Geometry.Box.prototype.containsPoint=function(e){var t=this,i=function(e){var i=t.position.copy().addVector3(e).addVector3(t.offset);return i.multiply(t.scale.x,t.scale.y,t.scale.z),i=t.rotation.getRotatedPoint(i)},r=function(e,t,i,r){t=t.copy().subtract(e.x,e.y,e.z),i=i.copy().subtract(e.x,e.y,e.z);var n=t.copy().crossProduct(i).normalize(),a=r.copy().subtract(e.x,e.y,e.z),o=n.dotProduct(a);return o},n=i(new VROne.Vector3(0,0,0)),a=i(new VROne.Vector3(0,this.b,0)),o=i(new VROne.Vector3(this.a,this.b,0)),s=i(new VROne.Vector3(0,0,this.c)),h=i(new VROne.Vector3(this.a,0,this.c)),l=i(new VROne.Vector3(0,this.b,this.c)),u=i(new VROne.Vector3(this.a,this.b,this.c)),d=r(l,a,u,e),c=r(s,h,n,e),p=r(l,s,n,e),f=r(u,o,h,e),g=r(l,u,s,e),m=r(a,n,o,e),s=d>0&&c>0&&p>0&&f>0&&g>0&&m>0;return s},VROne.Geometry.Sphere=function(e){VROne.Geometry.call(this),this.r=e||0},VROne.Geometry.Sphere.prototype=new VROne.Geometry,VROne.Geometry.Sphere.prototype.getO3D=function(e,t,i){this.scale=null;var r,n,a=t||10,o=i||10,s=this.r,h=this.offset,l=new VROne.Object3D;for(l.vertices=[],l.normals=[],l.textureCoords=[],r=0;o>=r;r++){var u=r*Math.PI/o,d=Math.sin(u),c=Math.cos(u);for(n=0;a>=n;n++){var p=2*n*Math.PI/a,f=Math.sin(p),g=Math.cos(p),m=g*d,x=c,v=f*d,R=1-n/a,V=1-r/o;l.normals.push(m,x,v),l.textureCoords.push(R,V),l.vertices.push(s*m+h.x,s*x+h.y,s*v+h.z)}}for(e&&(l.isWireframe=!0),l.indices=[],r=0;o>r;r++)for(n=0;a>n;n++){var y=r*(a+1)+n,O=y+a+1;e?(l.indices.push(O+1,O),l.indices.push(O,y),l.indices.push(y+1,y),l.indices.push(y+1,O+1)):(l.indices.push(y+1,O,y),l.indices.push(y+1,O+1,O))}return l.position=this.position,l.rotation=this.rotation,l},VROne.Geometry.CollisionMath={},VROne.Geometry.CollisionMath.ObjectPool={corners1:[new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3],corners2:[new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3],normals:[new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3,new VROne.Vector3],edgeNormalV1:new VROne.Vector3,edgeNormalV2:new VROne.Vector3},VROne.Geometry.CollisionMath.calcCorner=function(e,t,i,r,n){e.x=i?t.a:0,e.y=r?t.b:0,e.z=n?t.c:0,e.addVector3(t.offset),e.multiply(t.scale.x,t.scale.y,t.scale.z),t.rotation.getConjugate().rotatePoint(e),e.addVector3(t.position)},VROne.Geometry.CollisionMath.calcNormal=function(e,t,i,r){var n=i.x-t.x,a=i.y-t.y,o=i.z-t.z,s=r.x-t.x,h=r.y-t.y,l=r.z-t.z;e.x=a*l-o*h,e.y=o*s-n*l,e.z=n*h-a*s,e.normalize()},VROne.Geometry.CollisionMath.getEdgeNormal=function(e,t,i,r){var n=VROne.Geometry.CollisionMath.ObjectPool.edgeNormalV1;n.x=i.x-t.x,n.y=i.y-t.y,n.z=i.z-t.z,n.normalize();var a=n.x*(r.x-t.x)+n.y*(r.y-t.y)+n.z*(r.z-t.z);e.x=n.x*a+t.x-r.x,e.y=n.y*a+t.y-r.y,e.z=n.z*a+t.z-r.z,e.normalize()},VROne.Geometry.prototype.boxBoxCollision=function(e,t){var i=VROne.Geometry.CollisionMath.calcCorner,r=VROne.Geometry.CollisionMath.calcNormal,n=VROne.Geometry.CollisionMath.ObjectPool.corners1;i(n[0],e,!1,!1,!1),i(n[1],e,!0,!1,!1),i(n[2],e,!1,!0,!1),i(n[3],e,!0,!0,!1),i(n[4],e,!1,!1,!0),i(n[5],e,!0,!1,!0),i(n[6],e,!1,!0,!0),i(n[7],e,!0,!0,!0);var a=VROne.Geometry.CollisionMath.ObjectPool.corners2;i(a[0],t,!1,!1,!1),i(a[1],t,!0,!1,!1),i(a[2],t,!1,!0,!1),i(a[3],t,!0,!0,!1),i(a[4],t,!1,!1,!0),i(a[5],t,!0,!1,!0),i(a[6],t,!1,!0,!0),i(a[7],t,!0,!0,!0);var o=VROne.Geometry.CollisionMath.ObjectPool.normals,s=6;r(o[0],n[0],n[1],n[2]),r(o[1],n[0],n[4],n[2]),r(o[2],n[0],n[1],n[4]),r(o[3],a[0],a[1],a[2]),r(o[4],a[0],a[4],a[2]),r(o[5],a[0],a[1],a[4]);var h,l,u=null;for(h=0;s>h;h++){var d=o[h];if(0!==d.x||0!==d.y||0!==d.z){var c=null,p=null;for(l=0;l<n.length;l++){var f=d.dotProduct(n[l]);(null===c||c>f)&&(c=f),(null===p||f>p)&&(p=f)}var g=null,m=null;for(l=0;l<a.length;l++){var f=d.dotProduct(a[l]);(null===g||g>f)&&(g=f),(null===m||f>m)&&(m=f)}if(g>p||c>m)return null;var x=p-g;Math.abs(m-c)<Math.abs(x)&&(x=m-c),Math.abs(c-m)<Math.abs(x)&&(x=c-m),Math.abs(g-p)<Math.abs(x)&&(x=g-p),c>g&&(x=-x);var v=d.copy().scaleBy(x);(null===u||u.getLength()>v.getLength())&&(u=v,u.normal=d,u.distance=x)}}return u},VROne.Geometry.prototype.boxSphereCollision=function(e,t,i){(0===e.a||0===e.b||0===e.c)&&(i=!0);var r=VROne.Geometry.CollisionMath.calcCorner,n=VROne.Geometry.CollisionMath.calcNormal,a=VROne.Geometry.CollisionMath.getEdgeNormal,o=VROne.Geometry.CollisionMath.ObjectPool.corners1;r(o[0],e,!1,!1,!1),r(o[1],e,!0,!1,!1),r(o[2],e,!1,!0,!1),r(o[3],e,!0,!0,!1),r(o[4],e,!1,!1,!0),r(o[5],e,!0,!1,!0),r(o[6],e,!1,!0,!0),r(o[7],e,!0,!0,!0);var s=t.position.copy().addVector3(t.offset),h=VROne.Geometry.CollisionMath.ObjectPool.normals,l=15;n(h[0],o[0],o[1],o[2]),n(h[1],o[0],o[2],o[4]),n(h[2],o[0],o[4],o[1]),a(h[3],o[0],o[1],s),a(h[4],o[1],o[5],s),a(h[5],o[4],o[5],s),a(h[6],o[4],o[0],s),a(h[7],o[2],o[6],s),a(h[8],o[7],o[6],s),a(h[9],o[7],o[3],s),a(h[10],o[3],o[2],s),a(h[11],o[0],o[2],s),a(h[12],o[1],o[3],s),a(h[13],o[7],o[5],s),a(h[14],o[6],o[4],s);var u,d,c=null;for(u=0;l>u;u++){var p=h[u];if(0!==p.x||0!==p.y||0!==p.z){var f=null,g=null;for(d=0;d<o.length;d++){var m=p.dotProduct(o[d]);(null===f||f>m)&&(f=m),(null===g||m>g)&&(g=m)}var x=p.dotProduct(s),v=x-t.r,R=x+t.r;if(v>g||f>R)return null;var V=g-v;Math.abs(R-f)<Math.abs(V)&&(V=R-f),Math.abs(f-R)<Math.abs(V)&&(V=f-R),Math.abs(v-g)<Math.abs(V)&&(V=v-g);var y=p.copy().scaleBy(V);(i&&f>v||!i&&v>f)&&y.negate(),(null===c||c.getLength()>y.getLength())&&(c=y,c.distance=V,c.normal=p)}}return c},VROne.Geometry.prototype.sphereSphereCollision=function(e,t){var i=e.position.copy().addVector3(e.offset),r=t.position.copy().addVector3(t.offset),n=i.copy().subtract(r.x,r.y,r.z).getLength();if(n<e.r+t.r){var a=e.position,o=t.position.copy().subtract(a.x,a.y,a.z).normalize().scaleBy(e.r+t.r-n);return o.distance=n,o.normal=o,o}return null},VROne.Timer=function(){},VROne.Timer.prototype={},VROne.Timer.prototype.getCurrentTimeMs=function(){return(new Date).getTime()},VROne.Loader=function(){},VROne.Loader.getSourceSynch=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),200==t.status?t.responseText:null},VROne.Loader.prototype={},VROne.Renderer=function(e){var t,i=0,r=this;this.init=function(){n()};var n=function(){a(e),t.clearColor(0,0,0,1),r.setViewportAndScissor(0,0,t.viewportWidth,t.viewportHeight),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.cullFace(t.FRONT),t.frontFace(t.CW),t.enable(t.SCISSOR_TEST)},a=function(e){e.width=document.body.clientWidth,e.height=document.body.clientHeight;try{var i={alpha:!1};t=e.getContext("webgl",i),t||(t=e.getContext("experimental-webgl",i)),t.viewportWidth=e.width,t.viewportHeight=e.height,t.ext=t.getExtension("OES_vertex_array_object"),t.ext=null,t.ext||console.error("Can't get OES_vertex_array_object extension.")}catch(r){}t||alert("Could not initialise WebGL.")};this.update=function(e,t,r){for(i=0;i<t.length;i++)t[i].buffer.update(e);for(i=0;i<r.length;i++)r[i].buffer.update(e)},this.render=function(e,r,n){t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var a;for(i=0;i<r.length;i++)a=r[i].buffer,a.render();for(i=0;i<n.length;i++)a=n[i].buffer,a.render()},this.setViewportAndScissor=function(e,i,r,n){t.viewport(e,i,r,n),t.scissor(e,i,r,n),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},this.getBuffer=function(e,i){if(!e instanceof VROne.Object3D)throw"Can't get Buffer for "+e;return new VROne.BufferMulti(t,e,i)},this.getCanvasHeight=function(){return t.viewportHeight},this.getCanvasWidth=function(){return t.viewportWidth},this.getGL=function(){return t}},VROne.Renderer.prototype={},VROne.VRRenderer=function(e,t,i){function r(){var e=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,e),p=e.width=1024,f=e.height=1024;var t=h.createTexture();h.bindTexture(h.TEXTURE_2D,t),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,e.width,e.height,0,h.RGBA,h.UNSIGNED_BYTE,null);var i=h.createRenderbuffer();return h.bindRenderbuffer(h.RENDERBUFFER,i),h.renderbufferStorage(h.RENDERBUFFER,h.DEPTH_COMPONENT16,e.width,e.height),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,t,0),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,i),h.bindTexture(h.TEXTURE_2D,null),h.bindRenderbuffer(h.RENDERBUFFER,null),h.bindFramebuffer(h.FRAMEBUFFER,null),[e,t]}function n(){var e,t=x.vertices.slice();for(e=M;e<=x.vertices.length;e+=M)t.splice(e+(e/M-1)*w,0,x.textureCoords[(e/M-1)*w],x.textureCoords[(e/M-1)*w+1]);O=4*(M+w),m=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,m),h.bufferData(h.ARRAY_BUFFER,new Float32Array(t),h.STATIC_DRAW),m.numItems=4,h.enableVertexAttribArray(g.vertexPositionAttribute),h.vertexAttribPointer(g.vertexPositionAttribute,M,h.FLOAT,!1,O,0),h.enableVertexAttribArray(g.textureCoordAttribute),h.vertexAttribPointer(g.textureCoordAttribute,w,h.FLOAT,!1,O,4*M)}function a(e,t){h.bindFramebuffer(h.FRAMEBUFFER,l),R.setViewportAndScissor(0,0,p,f),s(e,"left"),s(t,"left"),h.bindFramebuffer(h.FRAMEBUFFER,u),R.setViewportAndScissor(0,0,p,f),s(e,"right"),s(t,"right"),h.bindFramebuffer(h.FRAMEBUFFER,null),g.initShaders(),h.bindBuffer(h.ARRAY_BUFFER,m),h.vertexAttribPointer(g.vertexPositionAttribute,M,h.FLOAT,!1,O,0),h.vertexAttribPointer(g.textureCoordAttribute,w,h.FLOAT,!1,O,4*M),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,d),h.uniform1i(g.samplerUniform,0),R.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(g.pMatrixUniform,!1,v.getPerspectiveMatrix().data),h.uniformMatrix4fv(g.mvMatrixUniform,!1,v.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,m.numItems),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,c),h.uniform1i(g.samplerUniform,0),R.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),h.uniformMatrix4fv(g.pMatrixUniform,!1,v.getPerspectiveMatrix().data),h.uniformMatrix4fv(g.mvMatrixUniform,!1,v.getViewMatrix().data),h.drawArrays(h.TRIANGLE_STRIP,0,m.numItems),h.bindTexture(h.TEXTURE_2D,null)}function o(e,t){R.setViewportAndScissor(0,0,h.viewportWidth,h.viewportHeight),s(e,"left"),s(t,"left"),R.setViewportAndScissor(h.viewportWidth,0,h.viewportWidth,h.viewportHeight),s(e,"right"),s(t,"right")}function s(e,t){for(var i=0;i<e.length;i++)e[i].buffer.renderVR(t)}VROne.Renderer.call(this,e);var h,l,u,d,c,p,f,g,m,x,v,R=this,V=0,y="VROne/shader/",O=0,M=3,w=2,b=this.init;this.init=function(){console.log("Initializing VRRenderer"),b(),h=this.getGL();var t=r();l=t[0],d=t[1],t=r(),u=t[0],c=t[1],x=new VROne.VRSquare;var a=VROne.Loader.getSourceSynch(y+x.shader+".vert"),o=VROne.Loader.getSourceSynch(y+x.shader+".frag");g=new VROne.Shader(h,a,o),g.pMatrixUniform=g.getUniformLocation("uPMatrix"),g.mvMatrixUniform=g.getUniformLocation("uMVMatrix"),g.vertexPositionAttribute=g.getAttribLocation("aVertexPosition"),g.textureCoordAttribute=g.getAttribLocation("aTextureCoord"),g.samplerUniform=g.getUniformLocation("uSampler");var s=new VROne.DeviceConfig;s.getPosition().set(0,0,2.3),s.getOrientation().set(0,0,0,1),v=new VROne.Camera(new VROne.CameraController(s),!1),v.isOrtho=!0,v.updateProjectionMatrix(),v.update(),n();var p=window.innerWidth*window.devicePixelRatio,f=window.innerHeight*window.devicePixelRatio;console.log(p+" x "+f);var m=i?i.cameraProperties.renderRectWidth:p,R=i?i.cameraProperties.renderRectHeight:f;i||console.warn("Can't get renderRect from cameraProperties."),h.viewportWidth=m/2,h.viewportHeight=R,e.width=m,e.height=R,e.style.width=window.innerWidth+"px",e.style.height=window.innerHeight+"px",console.log("Resolution: "+e.width+"x"+e.height),h.enable(h.SCISSOR_TEST)},this.update=function(e,t,i){for(V=0;V<t.length;V++)t[V].buffer.updateVR(e);for(V=0;V<i.length;V++)i[V].buffer.updateVR(e)},this.render=function(e,i,r){t?a(i,r):o(i,r)}},VROne.VRRenderer.prototype=VROne.Renderer.prototype,VROne.Scene=function(e){function t(e){var t=new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search);return decodeURIComponent((t||[void 0,""])[1].replace(/\+/g,"%20"))||null}var i,r=this,n=0,a=!1,o=null,s=null,h=null,l=null,u=[],d=[],c=new VROne.LightContainer;this.init=function(){a="true"===t("mobile");var r=!("false"===t("distorted")),n=!("false"===t("vr")),u="true"===t("desktop"),d=[],c=null;!u&&n&&VROne.HMDHandler.isWebVRReady()?(console.log("Using WebVR CameraController"),l=new VROne.WebVR,d.push(l),c=new VROne.CameraController(d),s=new VROne.VRRenderer(e,!1,c)):!u&&a?(console.log("Using MotionSensors CameraController"),d.push(new VROne.Cardboard),s=n?new VROne.VRRenderer(e,r):new VROne.Renderer(e),c=new VROne.CameraController(d)):(console.log("Using Desktop CameraController"),l=new VROne.MouseKeyboard(e),d.push(l),s=new VROne.Renderer(e),c=new VROne.CameraController(d)),i=new VROne.Camera(c,n&&a||VROne.HMDHandler.isWebVRReady()),o=new VROne.AudioContainer,h=new VROne.KeyboardHandler,this.resize()},this.resize=function(){console.log("Resize"),s.init(),i.width=s.getCanvasWidth(),i.height=s.getCanvasHeight(),i.updateProjectionMatrix()},this.updateScene=function(){VROne.Scene.frameJustStarted=!0;var e;for(h.update(),i.update(),c.update(i),l&&l.update(i.getController().getOrientation().getConjugate()),e=0;e<u.length;e++)u[e].update();for(e=0;e<d.length;e++)d[e].update();for(s.update(i,u,d),e=0;e<o.sounds.length;e++)o.sounds[e].listener=i.getControls().position,o.sounds[e].update()},this.drawScene=function(){for(var e=0,t=0;t<d.length;t++)if(!d[t].renderPriority){var r=d[t].getGlobalPosition(),n=i.getController();d[t].distance=Math.sqrt(Math.pow(n.getPosition().x-r.x,2)+Math.pow(n.getPosition().y-r.y,2)+Math.pow(n.getPosition().z-r.z,2)),d[t].distance>e&&(e=d[t].distance)}for(t=0;t<d.length;t++)d[t].renderPriority&&(d[t].distance=d[t].renderPriority>0?e+d[t].renderPriority:d[t].renderPriority);d.sort(function(e,t){return t.distance-e.distance}),s.render(i,u,d)},this.addToScene=function(e){if(e instanceof VROne.Light)c.addLight(e);else if(e instanceof VROne.Object3D)e.buffer=s.getBuffer(e,c),e.transparent?d.push(e):u.push(e),e.calcBoundingBox(),e.calcBoundingSphere();else{if(!(e instanceof VROne.Sound))throw"Can't add to scene: "+typeof e;e.listener=i.getControls().position,e.init(o),o.sounds.push(e)}},this.removeFromScene=function(e){if(e instanceof VROne.Light)c.removeLight(e);else if(e instanceof VROne.Object3D){for(n=0;n<u.length;n++)u[n]===e&&u.splice(n,1);for(n=0;n<d.length;n++)d[n]===e&&d.splice(n,1)}else{if(!(e instanceof VROne.Sound))throw"Can't remove from scene: "+typeof e;for(n=0;n<o.sounds.length;n++)o.sounds[n]===e&&o.sounds.splice(n,1)}},"undefined"!=typeof e&&(e.onclick=function(){(VROne.HMDHandler.isWebVRReady()||a)&&(i.setFullScreen(!0),"orientation"in screen&&screen.orientation.lock("landscape-primary"),r.resize())}),this.getCamera=function(){return i}},VROne.Scene.frameJustStarted=!0,VROne.Camera=function(e,t){console.log("Camera useVR: "+t),this.isVR=t;var i=!1,r=new VROne.Vector3,n=new VROne.Quaternion,a=new VROne.Matrix4,o=new VROne.Matrix4,s=new VROne.Matrix4,h=new VROne.Matrix4,l=null,u=null,d=null;this.fieldOfView=60,this.nearPlane=.1,this.farPlane=200,this.width=1,this.height=1,this.isOrtho=!1;var c=new VROne.Vector3;this.update=function(){e.update(),r=e.getPosition(),n=e.getOrientation().getConjugate(),p()},this.updateProjectionMatrix=function(){var t=this.width/this.height;e&&e.isInputVR()&&e.cameraProperties.eyeFOVL?(u=VROne.Matrix4.makeVRPerspective(e.cameraProperties.eyeFOVL,this.nearPlane,this.farPlane),d=VROne.Matrix4.makeVRPerspective(e.cameraProperties.eyeFOVR,this.nearPlane,this.farPlane)):l=this.isOrtho?VROne.Matrix4.makeOrthoPerspective(-1,1,1,-1,.5,1.5):VROne.Matrix4.makePerspective(this.fieldOfView,t,this.nearPlane,this.farPlane)},this.setFullScreen=function(t){if(i!==t){var r={};void 0!==e.cameraProperties.vrDevice&&(r={vrDisplay:e.cameraProperties.vrDevice,vrTimewarp:!0}),canvas.mozRequestFullScreen?canvas.mozRequestFullScreen(r):canvas.webkitRequestFullscreen&&canvas.webkitRequestFullscreen(r)}};var p=function(){if(t){var i=e.cameraProperties.eyeTranslationL,l=e.cameraProperties.eyeTranslationR;s.identity(),s.appendTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(a),s.append(a),s.appendTranslation(-i,0,0),h.identity(),h.appendTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(a),h.append(a),h.appendTranslation(-l,0,0)}else o.identity(),o.appendTranslation(-r.x,-r.y,-r.z),n.toRotationMatrix(a),o.append(a)};this.getController=function(){return e},this.getViewMatrix=function(e){return"left"===e?s:"right"===e?h:o},this.getPerspectiveMatrix=function(e){return"left"===e&&null!==u?u:"right"===e&&null!==d?d:l},this.getEyeTranslation=function(t){return"left"===t?e.cameraProperties.eyeTranslationL:"right"===t?e.cameraProperties.eyeTranslationR:null},this.getForwardVector=function(){return t?(c.x=-s.data[2],c.y=-s.data[6],c.z=-s.data[10],c):(c.x=-o.data[2],c.y=-o.data[6],c.z=-o.data[10],c)}},VROne.Camera.prototype={},VROne.Light=function(){this.position=new VROne.Vector3,this.color={red:1,green:1,blue:1},this.specularColor={red:1,green:1,blue:1}},VROne.Light.prototype={ambientLight:{red:.5,green:.5,blue:.5}},VROne.LightContainer=function(){var e=[];this.locationsArray=[],this.locationsArrayLeftEye=[],this.locationsArrayRightEye=[],this.colorsArray=[],this.specColorsArray=[],this.lightsCount=0;var t=new VROne.Vector3;this.addLight=function(t){e.push(t)},this.removeLight=function(t){var i=e.indexOf(t);-1!==i&&e.splice(i,1),this.locationsArray.splice(i,1),this.colorsArray.splice(i,1),this.specColorsArray.splice(i,1)},this.update=function(i){var r=0;if(i.isVR){var n,a=i.getViewMatrix("left");for(r=0;r<e.length;r++)VROne.Vector3.prototype.copyToVector(e[r].position,t),n=a.transformVector(t),this.locationsArrayLeftEye[3*r+0]=n.x,this.locationsArrayLeftEye[3*r+1]=n.y,this.locationsArrayLeftEye[3*r+2]=n.z;var a=i.getViewMatrix("right");for(r=0;r<e.length;r++)VROne.Vector3.prototype.copyToVector(e[r].position,t),n=a.transformVector(t),this.locationsArrayRightEye[3*r+0]=n.x,this.locationsArrayRightEye[3*r+1]=n.y,this.locationsArrayRightEye[3*r+2]=n.z}else{var a=i.getViewMatrix();for(r=0;r<e.length;r++){VROne.Vector3.prototype.copyToVector(e[r].position,t);var n=a.transformVector(t);this.locationsArray[3*r+0]=n.x,this.locationsArray[3*r+1]=n.y,this.locationsArray[3*r+2]=n.z}}for(r=0;r<e.length;r++)this.colorsArray[3*r+0]=e[r].color.red,this.colorsArray[3*r+1]=e[r].color.green,this.colorsArray[3*r+2]=e[r].color.blue,this.specColorsArray[3*r+0]=e[r].specularColor.red,this.specColorsArray[3*r+1]=e[r].specularColor.green,this.specColorsArray[3*r+2]=e[r].specularColor.blue;this.lightsCount=e.length}},VROne.LightContainer.prototype={},VROne.Buffer=function(e,t,i,r,n,a){a=a||e.TRIANGLES;var o,s,h,l,u=[],d=[],c=[];this.indices=null,this.useTexture=!1,this.useSpecularMap=!1,this.useTransparency=!1,this.texturesO3D=null,this.isSkybox=!1;var p=!1,f=!1,g=!1,m=0,x=0;this.init=function(){p=this.useTexture,f=this.useSpecularMap,g=this.useNormalMap;var a,v=0;for(m=0;m<r.length;m++)a=r[m],a[3]=i.getAttribLocation(a[0]),a[4]=v,v+=4*a[1],x+=4*a[1];for(m=0;m<n.length;m++){var R=n[m];R[4]=new Array(1+R[3].length),R[4][0]=i.getUniformLocation(R[0])}if(this.useTexture)for(i.samplerUniform=i.getUniformLocation("uSampler"),m=0;m<this.texturesO3D.length;m++)u.push(this.loadTexture(e,this.texturesO3D[m],this.isSkybox));if(this.useSpecularMap)for(this.texturesO3D=Array.isArray(t.specularMap)?t.specularMap:[t.specularMap],i.specularMapUniform=i.getUniformLocation("uSpecularMapSampler"),m=0;m<this.texturesO3D.length;m++)d.push(this.loadTexture(e,this.texturesO3D[m],this.isSkybox));if(this.useNormalMap)for(this.texturesO3D=Array.isArray(t.normalMap)?t.normalMap:[t.normalMap],i.normalMapUniform=i.getUniformLocation("uNormalMapSampler"),m=0;m<this.texturesO3D.length;m++)c.push(this.loadTexture(e,this.texturesO3D[m],this.isSkybox));
for(var V=[],y=0;y<r[0][2].length/r[0][1];y++)for(m=0;m<r.length;m++)a=r[m],this.pushData(V,a[2],y,a[1]);if(s=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(V),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),o=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),h=this.indices.length,e.ext){for(l=e.ext.createVertexArrayOES(),e.ext.bindVertexArrayOES(l),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.bindBuffer(e.ARRAY_BUFFER,s),m=0;m<r.length;m++)a=r[m],this.setupAttribPointer(e,a[3],a[1],x,a[4]),v+=4*a[1];e.bindBuffer(e.ARRAY_BUFFER,null),e.ext.bindVertexArrayOES(null)}},this.update=function(){p&&(p=v(p,u)),f&&(f=v(f,d)),g&&(g=v(g,c))};var v=function(e,t){if(e){var i=!0;for(m=0;m<t.length;m++)if(!t[m].loaded){i=!1;break}e=!i}return e};this.render=function(){if(!(p||f||g)){if(this.useTransparency&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)),i.initShaders(),this.useTexture&&this.activateTextures(e,i.samplerUniform,u),this.useSpecularMap){for(m=0;m<d.length;m++)e.activeTexture(e.TEXTURE0+u.length+m),e.bindTexture(e.TEXTURE_2D,d[m]);e.uniform1i(i.specularMapUniform,1)}if(this.useNormalMap){for(m=0;m<c.length;m++)e.activeTexture(e.TEXTURE0+u.length+m),e.bindTexture(e.TEXTURE_2D,c[m]);e.uniform1i(i.normalMapUniform,1)}for(m=0;m<n.length;m++){var t=n[m];if(t[4][1]=t[3],t[2])for(var v=0;v<t[3].length;v++)t[4][v+1]=t[2][t[3][v]]}for(m=0;m<n.length;m++)e[n[m][1]].apply(e,n[m][4]);if(e.ext)e.ext.bindVertexArrayOES(l),e.drawElements(a,h,e.UNSIGNED_SHORT,0),e.ext.bindVertexArrayOES(null);else{for(e.bindBuffer(e.ARRAY_BUFFER,s),m=0;m<r.length;m++){var R=r[m];this.setupAttribPointer(e,R[3],R[1],x,R[4])}e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.drawElements(a,h,e.UNSIGNED_SHORT,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}this.useTransparency&&e.disable(e.BLEND)}}},VROne.Buffer.prototype={pushData:function(e,t,i,r){var n;for(n=0;r>n;n++)e.push(t[i*r+n])},setupAttribPointer:function(e,t,i,r,n){e.enableVertexAttribArray(t),e.vertexAttribPointer(t,i,e.FLOAT,!1,r,n)},loadedTextures:{},loadTexture:function(e,t,i){var r=e.createTexture();r.loaded=!1;var n=e.REPEAT;return(i||t.clamp)&&(n=e.CLAMP_TO_EDGE),t=t.source?t.source:t,this.loadedTextures[t]?(r.loaded=!0,this.loadedTextures[t]):(r.image=new Image,r.image.src=t,r.image.onload=function(){e.bindTexture(e.TEXTURE_2D,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,n),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),r.loaded=!0},this.loadedTextures[t]=r,r)},activateTextures:function(e,t,i){for(var r=[],n=0;n<i.length;n++)e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,i[n]),r.push(n);e.uniform1iv(t,r)}},VROne.BufferMulti=function(e,t,i){if(!t instanceof VROne.Object3D)throw"Can't create buffers for "+t;var r=new VROne.Matrix4;r.transposeUniform=!1;var n=new VROne.Matrix4,a=new VROne.Matrix4,o=new VROne.Matrix3,s=new VROne.Matrix3,h=null,l=null,u=3,d=3,c=2,p=1,f=4,g=Boolean(t.normals),m=Array.isArray(t.imageSrc)?t.imageSrc.length:1,x=t.isWireframe;this.transparent=t.transparent;var v=Boolean(t.geometries&&t.velocities&&t.rotationAngles&&t.lifetimes&&t.gravities&&t.gravityExps),R=[];R.push(["aVertexPosition",u,t.vertices]),t.textureCoords&&t.imageSrc&&R.push(["aTextureCoord",c,t.textureCoords]),t.textureCoords&&t.imageSrc&&t.textureIndices&&m>1&&R.push(["aTextureIndex",p,t.textureIndices]),t.colors&&R.push(["aVertexColor",f,t.colors]),t.normals&&R.push(["aVertexNormal",d,t.normals]),t.shaderAttributes&&Array.prototype.push.apply(R,t.shaderAttributes);var V={transposeUniform:!1,data:[]},y={time:0,startTime:Date.now()},O={useTexture:Boolean(t.textureCoords&&t.imageSrc),useLighting:Boolean(t.normals),useMultiTex:Boolean(t.textureIndices),normalMatrix:new VROne.Matrix3,useSpecularMap:Boolean(t.specularMap),useNormalMap:Boolean(t.normalMap)},M=[];M.push(["uPMatrix","uniformMatrix4fv",V,["transposeUniform","data"]]),M.push(["uMVMatrix","uniformMatrix4fv",r,["transposeUniform","data"]]),g&&(O.normalMatrix.transposeUniform=!1,M.push(["uNMatrix","uniformMatrix3fv",O.normalMatrix,["transposeUniform","data"]]),M.push(["uAmbientColor","uniform3f",VROne.Light.prototype.ambientLight,["red","green","blue"]]),M.push(["uLightIndex","uniform1f",i,["lightsCount"]]),M.push(["uPointLightingLocations","uniform3fv",i,["locationsArray"]]),M.push(["uPointLightingColors","uniform3fv",i,["colorsArray"]]),M.push(["uSpecularColors","uniform3fv",i,["specColorsArray"]]),M.push(["uShininess","uniform1f",t,["shininess"]])),v&&M.push(["uTime","uniform1f",y,["time"]]),t.shaderUniforms&&Array.prototype.push.apply(M,t.shaderUniforms);var w=null,b=null,S="";if(t.shader){console.log("Loading Shader File: "+t.shader);var C="VROne/shader/";w=VROne.Loader.getSourceSynch(C+t.shader+".vert"),b=VROne.Loader.getSourceSynch(C+t.shader+".frag"),S="A"+t.shader}else{var T=new VROne.ShaderGenerator;T.lightsCount=10,T.texturesCount=Array.isArray(t.imageSrc)?t.imageSrc.length:1,T.useVertexLighting=Boolean(t.normals&&!t.useFragmentLighting),T.useFragmentLighting=Boolean(t.normals&&t.useFragmentLighting),T.useTexture=Boolean(t.imageSrc&&t.textureCoords),T.useColor=Boolean(t.colors),T.useSpecularMap=Boolean(t.specularMap),T.useNormalMap=Boolean(t.normalMap),T.isParticleSystem=v,T.init(),w=T.vertexShader,b=T.fragmentShader,S="B"+T.lightsCount+T.texturesCount+T.useVertexLighting+T.useFragmentLighting+T.useTexture+T.useColor+T.useSpecularMap+T.useNormalMap+T.isParticleSystem}var A=null;VROne.Shader.prototype[S]?A=VROne.Shader.prototype[S]:(A=new VROne.Shader(e,w,b),VROne.Shader.prototype[S]=A);var E=x?e.LINES:void 0,P=new VROne.Buffer(e,t,A,R,M,E);if(t.twoFaceTransparency){var D=t.indices;D=D.slice().reverse().concat(D),P.indices=new Uint16Array(D)}else P.indices=new Uint16Array(t.indices);P.useTexture=Boolean(t.textureCoords&&t.imageSrc),P.useSpecularMap=Boolean(t.textureCoords&&t.specularMap),P.useNormalMap=Boolean(t.textureCoords&&t.normalMap),P.useTransparency=t.transparent,P.texturesO3D=Array.isArray(t.imageSrc)?t.imageSrc:[t.imageSrc],P.isSkybox=Boolean(t.isSkybox),P.init();var L=new VROne.Matrix4;this.update=function(e){VROne.Matrix4.prototype.copyToMatrix(t.modelMatrix,r),r.append(e.getViewMatrix()),VROne.Matrix4.prototype.copyToMatrix(r,L),L.invert(),L.transpose(),L.getMatrix3(O.normalMatrix),V.data=e.getPerspectiveMatrix().data,y=Date.now()-y.startTime,P.update()},this.render=function(){t.visible&&P.render()},this.updateVR=function(e){VROne.Matrix4.prototype.copyToMatrix(t.modelMatrix,n),n.append(e.getViewMatrix("left")),VROne.Matrix4.prototype.copyToMatrix(n,L),L.invert(),L.transpose(),L.getMatrix3(o),VROne.Matrix4.prototype.copyToMatrix(t.modelMatrix,a),a.append(e.getViewMatrix("right")),VROne.Matrix4.prototype.copyToMatrix(a,L),L.invert(),L.transpose(),L.getMatrix3(s),h=e.getPerspectiveMatrix("left"),l=e.getPerspectiveMatrix("right"),P.update()},this.renderVR=function(e){"left"===e?(r.data=n.data,O.normalMatrix.data=o.data,V.data=h.data,i.locationsArray=i.locationsArrayLeftEye):"right"===e&&(r.data=a.data,O.normalMatrix.data=s.data,V.data=l.data,i.locationsArray=i.locationsArrayRightEye),P.render()}},VROne.BufferMulti.prototype={},VROne.Shader=function(e,t,i){var r=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return alert("ShaderVert: \n"+e.getShaderInfoLog(r)),null;var n=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(n,i),e.compileShader(n),!e.getShaderParameter(r,e.COMPILE_STATUS))return alert("ShaderFrag: \n"+e.getShaderInfoLog(n)),null;var a=e.createProgram();e.attachShader(a,r),e.attachShader(a,n),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)||alert("Could not initialise shaders"),e.validateProgram(a),this.initShaders=function(){e.useProgram(a)},this.getAttribLocation=function(t){return e.getAttribLocation(a,t)},this.getUniformLocation=function(t){return e.getUniformLocation(a,t)}},VROne.Shader.prototype={},VROne.ShaderGenerator=function(){this.lightsCount=10,this.texturesCount=1,this.useVertexLighting=!1,this.useFragmentLighting=!1,this.useTexture=!1,this.useColor=!1,this.useSpecularMap=!1,this.useNormalMap=!1,this.isParticleSystem=!1;var e=!1;this.vertexShader="",this.fragmentShader="",this.init=function(){this.useTexture||(this.useSpecularMap=!1,this.useNormalMap=!1),e=Boolean(this.texturesCount>1),this.vertexShader+="attribute vec3 aVertexPosition;",this.useColor&&(this.vertexShader+="attribute vec4 aVertexColor;"),this.useTexture&&(this.vertexShader+="attribute vec2 aTextureCoord;"),(this.useVertexLighting||this.useFragmentLighting)&&(this.vertexShader+="attribute vec3 aVertexNormal;"),this.isParticleSystem&&(this.vertexShader+="attribute vec3 aGeometryPosition;attribute vec3 aVertexVelocity;attribute vec3 aVertexRotation;attribute float aLifetime;attribute float aGravity;attribute float aGravityExponent;"),this.useTexture&&e&&(this.vertexShader+="attribute float aTextureIndex;"),this.vertexShader+="uniform mat4 uMVMatrix;uniform mat4 uPMatrix;",this.isParticleSystem&&(this.vertexShader+="uniform float uTime;"),(this.useVertexLighting||this.useFragmentLighting)&&(this.vertexShader+="uniform mat3 uNMatrix;"),this.useVertexLighting&&(this.vertexShader+="uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];uniform vec3 uSpecularColors["+this.lightsCount+"];uniform float uShininess;uniform float uLightIndex;"),this.useColor&&(this.vertexShader+="varying vec4 vColor;"),this.useTexture&&(this.vertexShader+="varying vec2 vTextureCoord;"),this.useVertexLighting?this.vertexShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.vertexShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;"),this.useTexture&&e&&(this.vertexShader+="varying float vTextureIndex;"),this.vertexShader+="void main(void) {",this.isParticleSystem?this.vertexShader+="float factor;if(aLifetime==0.0){factor = uTime;}else{factor = mod(uTime, aLifetime);}vec3 distance = aGeometryPosition - aVertexPosition;float xAngle = aVertexRotation.x*factor;float yAngle = aVertexRotation.y*factor;float zAngle = aVertexRotation.z*factor;mat4 xRotation = mat4(1.0,	 		 0.0,			 0.0,			 0.0,0.0,			 cos(xAngle),	 sin(xAngle),	 0.0,0.0,			-sin(xAngle),	 cos(xAngle),	 0.0,0.0,	 		 0.0,			 0.0,			 1.0);mat4 yRotation = mat4(cos(yAngle),	 0.0,			-sin(yAngle),	 0.0,0.0,			 1.0,	 		 0.0,			 0.0,sin(yAngle),	 0.0,	 		 cos(yAngle),	 0.0,0.0,			 0.0,	 		 0.0,			 1.0);mat4 zRotation = mat4(cos(zAngle),	 sin(zAngle),	 0.0,			 0.0,-sin(zAngle),	 cos(zAngle),	 0.0,			 0.0,0.0,			 0.0,			 1.0,			 0.0,0.0,			 0.0,			 0.0,			 1.0);vec4 position = vec4(aGeometryPosition, 1.0)*xRotation*yRotation*zRotation;position = position-vec4(distance, 0.0);vec3 velocity = aVertexVelocity+vec3(0.0, aGravity*pow(factor, aGravityExponent),0.0);position = uMVMatrix * vec4(position.xyz+velocity*factor, 1.0);":this.useFragmentLighting?this.useFragmentLighting&&(this.vertexShader+="vPosition = uMVMatrix * vec4(aVertexPosition, 1.0);vec4 position = vPosition;"):this.vertexShader+="vec4 position = uMVMatrix * vec4(aVertexPosition, 1.0);",this.vertexShader+="gl_Position = uPMatrix * position;",this.useTexture&&e&&(this.vertexShader+="vTextureIndex = aTextureIndex;"),this.useTexture&&(this.vertexShader+="vTextureCoord = aTextureCoord;"),this.useColor&&(this.vertexShader+="vColor = aVertexColor;"),this.useVertexLighting?(this.vertexShader+="vLightWeighting = uAmbientColor;",this.vertexShader+=this.isParticleSystem?"vec3 transformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vec3 transformedNormal = uNMatrix * aVertexNormal;",this.vertexShader+="vec3 normal = normalize(transformedNormal);vec3 eyeDirection = normalize(-position.xyz);"+this.getVertexLightingWeightCalcArrayVertex(this.lightsCount)):this.useFragmentLighting&&(this.vertexShader+=this.isParticleSystem?"vTransformedNormal = uNMatrix * (vec4(aVertexNormal, 1.0) * xRotation * yRotation * zRotation).xyz;":"vTransformedNormal = uNMatrix * aVertexNormal;"),this.vertexShader+="}",this.fragmentShader+="precision mediump float;",this.useVertexLighting?this.fragmentShader+="varying vec3 vLightWeighting;":this.useFragmentLighting&&(this.fragmentShader+="varying vec3 vTransformedNormal;varying vec4 vPosition;uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocations["+this.lightsCount+"];uniform vec3 uPointLightingColors["+this.lightsCount+"];uniform vec3 uSpecularColors["+this.lightsCount+"];uniform float uShininess;uniform float uLightIndex;"),this.useColor&&(this.fragmentShader+="varying vec4 vColor;"),this.useTexture&&(this.fragmentShader+="varying vec2 vTextureCoord;",this.fragmentShader+=e?"varying float vTextureIndex;uniform sampler2D uSampler["+this.texturesCount+"];":"uniform sampler2D uSampler;"),this.useSpecularMap&&(this.fragmentShader+="uniform sampler2D uSpecularMapSampler;"),this.useNormalMap&&(this.fragmentShader+="uniform sampler2D uNormalMapSampler;"),this.fragmentShader+="void main(void) {vec4 fragmentColor;",this.useFragmentLighting&&(this.fragmentShader+="vec3 lightWeighting = uAmbientColor;vec3 normal = normalize(vTransformedNormal);vec3 eyeDirection = normalize(-vPosition.xyz);"+this.getFragmentLightingWeightCalcArrayVertex(this.lightsCount,this.useSpecularMap,this.useNormalMap)),this.useTexture&&e?(this.fragmentShader+="if (vTextureCoord.x > -0.5 && vTextureCoord.y > -0.5) {vec4 tex = vec4(0.0);float i = vTextureIndex;"+this.getTextureCalcArray(this.texturesCount)+"fragmentColor = tex;} else {",this.fragmentShader+=this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+="}"):this.fragmentShader+=this.useTexture?"fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));":this.useColor?"fragmentColor = vColor;":"fragmentColor = vec4(0.5, 0.5, 0.5, 1.0);",this.fragmentShader+=this.useVertexLighting?"gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);":this.useFragmentLighting?"gl_FragColor = vec4(fragmentColor.rgb * lightWeighting, fragmentColor.a);":"gl_FragColor = vec4(fragmentColor.rgb, fragmentColor.a);",this.fragmentShader+="}"}},VROne.ShaderGenerator.prototype={getVertexLightingWeightCalcArrayVertex:function(e){for(var t="",i=0;e>i;i++)t+="if(uLightIndex-"+(i+1)+".0>-0.01){vec3 lightDirection = normalize(uPointLightingLocations["+i+"] - position.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);float diffuseLightWeighting = max(dot(normalize(transformedNormal), lightDirection), 0.0);vLightWeighting += uPointLightingColors["+i+"] * diffuseLightWeighting + uSpecularColors["+i+"] * specularLightWeighting;}";return t},getFragmentLightingWeightCalcArrayVertex:function(e,t,i){for(var r="",n=0;e>n;n++)r+="if(uLightIndex-"+(n+1)+".0>-0.01){vec3 lightDirection = normalize(uPointLightingLocations["+n+"] - vPosition.xyz);vec3 reflectionDirection = reflect(-lightDirection, normal);",r+=t?"float shininess = texture2D(uSpecularMapSampler, 255.0-vec2(vTextureCoord.s, vTextureCoord.t)).r * 255.0 * uShininess;float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess);":"float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uShininess);",r+=i?"vec3 normalMap = texture2D(uNormalMapSampler, vec2(vTextureCoord.s, vTextureCoord.t)).rgb*2.0-1.0;float diffuseLightWeighting = max(dot(normalize(normalMap), lightDirection), 0.0);":"float diffuseLightWeighting = max(dot(normalize(vTransformedNormal), lightDirection), 0.0);",r+="lightWeighting += uPointLightingColors["+n+"] * diffuseLightWeighting + uSpecularColors["+n+"] * specularLightWeighting;}";return r},getTextureCalcArray:function(e){for(var t="",i=0;e>i;i++)0!==i&&(t+="else "),t+="if(i-"+i+".0 < 0.01){tex = texture2D(uSampler["+i+"], vec2(vTextureCoord.s, vTextureCoord.t));}";return t}},VROne.Sound=function(e){var t,i=this,r=!1;this.position=new VROne.Vector3,this.listener=new VROne.Vector3;var n=null;this.init=function(a){n=a;var o=n.audioContext.createGain();n.audioContext.destination=o,o.connect(n.audioContext.destination),t={},t.source=n.audioContext.createBufferSource(),t.source.loop=!0,t.panner=n.audioContext.createPanner(),t.volume=n.audioContext.createGain(),t.source.connect(t.volume),t.volume.connect(t.panner),t.panner.connect(o),t.panner.setPosition(-1,0,0),t.panner.panningModel="HRTF",t.panner.distanceModel="linear",n.audioContext.listener.setOrientation(0,0,-1,0,1,0),n.audioContext.listener.setPosition(0,0,1);var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){n.audioContext.decodeAudioData(this.response,function(e){t.buffer=e,t.source.buffer=t.buffer,i.update(i.position.x,i.position.y,i.position.z),t.source.start(0),r=!0},function(){alert("Decoding the audio buffer failed")})},s.send()},this.update=function(){r&&(t.panner.setPosition(i.position.x,i.position.y,i.position.z),n.audioContext.listener.setPosition(i.listener.x,i.listener.y,i.listener.z))}},VROne.AudioContainer=function(){window.AudioContainer=window.AudioContext||window.webkitAudioContext||null,window.AudioContainer?this.audioContext=new AudioContext:(this.audioContext={},alert("AudioContainer not supported!")),this.sounds=[]},VROne.Object3D=function(){var e=this;this.position=new VROne.Vector3,this.rotation=new VROne.Quaternion;var t=new VROne.Vector3,i=new VROne.Quaternion,r=new VROne.Matrix4;this.scale=new VROne.Vector3(1,1,1),this.modelMatrix=new VROne.Matrix4,this.parent=null,this.parentPositionWeight=new VROne.Vector3(1,1,1),this.parentRotationWeight=new VROne.Vector3(1,1,1),this.vertices=null,this.normals=null,this.textureCoords=null,this.textureIndices=null,this.colors=null,this.indices=null,this.transparent=!1,this.isWireframe=!1,this.twoFaceTransparency=!1,this.shininess=1,this.buffer=null,this.imageSrc=null,this.shader=null,this.shaderAttributes=null,this.shaderUniforms=null,this.useFragmentLighting=!1,this.specularMap=null,this.normalMap=null,this.soundFile=null,this.sound=null,this.isSkybox=!1,this.boundingBox=null,this.boundingSphere=null,this.gravity=null,this.velocity=new VROne.Vector3,this.collision=!1,this.useBoundingSphere=!1,this.collideWith=null,this.onCollision=null;var n=VROne.Timer.prototype.getCurrentTimeMs();this.renderPriority=null,this.visible=!0,this.calcBoundingBox=function(){this.vertices||console.error("No Vertices set. Can't calc Bounding Box."),a();for(var e=this.vertices[0],r=this.vertices[0],n=this.vertices[1],o=this.vertices[1],s=this.vertices[2],h=this.vertices[2],l=0;l<this.vertices.length;l+=3){var u=this.vertices[l+0],d=this.vertices[l+1],c=this.vertices[l+2];u>r&&(r=u),e>u&&(e=u),d>o&&(o=d),n>d&&(n=d),c>h&&(h=c),s>c&&(s=c)}var p=r-e,f=o-n,g=h-s;this.boundingBox=new VROne.Geometry.Box(p,f,g),this.boundingBox.position=t,this.boundingBox.offset=new VROne.Vector3(e,n,s),this.boundingBox.rotation=i,this.boundingBox.scale=this.scale},this.calcBoundingSphere=function(){a();var e,r,n,o,s=this.scale,h=this.vertices[0]*s.x,l=this.vertices[0]*s.x,u=this.vertices[1]*s.y,d=this.vertices[1]*s.y,c=this.vertices[2]*s.z,p=this.vertices[2]*s.z;for(e=0;e<this.vertices.length;e+=3)r=this.vertices[e+0]*s.x,n=this.vertices[e+1]*s.y,o=this.vertices[e+2]*s.z,r>l&&(l=r),h>r&&(h=r),n>d&&(d=n),u>n&&(u=n),o>p&&(p=o),c>o&&(c=o);var f=new VROne.Vector3((l+h)/2,(d+u)/2,(p+c)/2),g=0;for(e=0;e<this.vertices.length;e+=3){r=this.vertices[e+0]*this.scale.x,n=this.vertices[e+1]*this.scale.y,o=this.vertices[e+2]*this.scale.z;var m=VROne.Vector3.prototype.distance(f,new VROne.Vector3(r,n,o));m>g&&(g=m)}this.boundingSphere=new VROne.Geometry.Sphere(g),this.boundingSphere.position=t,this.boundingSphere.offset=f,this.boundingSphere.rotation=i},this.update=function(){var e=VROne.Timer.prototype.getCurrentTimeMs(),o=e-n,s=this.gravity,h=this.velocity;if((s||0!==h.x||0!==h.y||0!==h.z)&&o>0){var l=o/1e3;if(s&&((s.x>0&&h.x<s.x||s.x<0&&h.x>s.x)&&(h.x=h.x+s.x*l),(s.y>0&&h.y<s.y||s.y<0&&h.y>s.y)&&(h.y=h.y+s.y*l),(s.z>0&&h.z<s.z||s.z<0&&h.z>s.z)&&(h.z=h.z+s.z*l)),this.position.x+=h.x*l,this.position.y+=h.y*l,this.position.z+=h.z*l,a(),this.collision&&this.collideWith)for(var u=0;u<this.collideWith.length;u++){var d=this.collideWith[u],c=this.boundingSphere.position.x+this.boundingSphere.offset.x-(d.boundingSphere.position.x+d.boundingSphere.offset.x),p=this.boundingSphere.position.y+this.boundingSphere.offset.y-(d.boundingSphere.position.y+d.boundingSphere.offset.y),f=this.boundingSphere.position.z+this.boundingSphere.offset.z-(d.boundingSphere.position.z+d.boundingSphere.offset.z),g=Math.sqrt(c*c+p*p+f*f),m=this.boundingSphere.r+d.boundingSphere.r;if(!(g>1.3*m)){var x;if(x=d.useBoundingSphere&&this.useBoundingSphere?VROne.Geometry.prototype.sphereSphereCollision(this.boundingSphere,d.boundingSphere):d.useBoundingSphere?VROne.Geometry.prototype.boxSphereCollision(this.boundingBox,d.boundingSphere,!0):this.useBoundingSphere?VROne.Geometry.prototype.boxSphereCollision(d.boundingBox,this.boundingSphere):VROne.Geometry.prototype.boxBoxCollision(this.boundingBox,d.boundingBox),x&&(this.position.subtract(x.x,x.y,x.z),this.onCollision)){var v={collisionWith:d,collisionVector:x.negate()};this.onCollision(v)}}}n=e}a(),this.modelMatrix.identity(),this.modelMatrix.appendScale(this.scale.x,this.scale.y,this.scale.z),i.toRotationMatrix(r),this.modelMatrix.append(r),this.modelMatrix.appendTranslation(t.x,t.y,t.z)};var a=function(){if(e.parent){var r=e.parent.rotation,n=e.parentRotationWeight,a=new VROne.Quaternion(r.x*n.x,r.y*n.y,r.z*n.z,r.w);a.normalize();var o=e.parent.position,s=e.parentPositionWeight,h=new VROne.Vector3(o.x*s.x,o.y*s.y,o.z*s.z);VROne.Quaternion.prototype.copyToQuaternion(e.rotation,i),i.multiply(a,i),a=a.getConjugate(),VROne.Vector3.prototype.copyToVector(a.getRotatedPoint(e.position),t),t.addVector3(h)}else VROne.Vector3.prototype.copyToVector(e.position,t),VROne.Quaternion.prototype.copyToQuaternion(e.rotation,i)};this.getGlobalPosition=function(){return t},this.getGlobalRotation=function(){return i}},VROne.Object3D.prototype={addShaderAttribute:function(e,t,i){this.shaderAttributes||(this.shaderAttributes=[]),this.shaderAttributes.push([e,t,i])},addShaderUniform:function(e,t,i,r){this.shaderUniforms||(this.shaderUniforms=[]),this.shaderUniforms.push([e,t,i,r])}},VROne.OBJLoader=function(e){for(var t=/(.*[\/|\\])(.*)/,i=t.exec(e)[1],r=t.exec(e)[2],n=VROne.Loader.getSourceSynch(i+r),a=this.getMtlName(n),o=VROne.Loader.getSourceSynch(i+a),s=this.readObj(n),h=a?this.readMtl(o):null,l=[],u=0;u<s.length;u++){var d=this.createO3DFromOBJ(s[u],h,i);l.push(d),l[s[u].name]=d}return console.log("OBJ load finished. Containing "+l.length+" Object(s)."),l},VROne.OBJLoader.prototype={readObj:function(e){var t=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,i=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,r=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,n=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,a=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,o=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,s=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,h=[],l={};l.name="",l.vertices=[],l.normals=[],l.uvs=[],l.faces=[];for(var u,d=function(e,t,i){if(void 0!==e[3])throw"obj quad rendering not supported";for(var r=[],n=0;3>n;n++){var a=e[n],o=t?t[n]:void 0,s=i?i[n]:void 0;r.push([a,o,s])}r.push(u),l.faces.push(r)},c=e.split("\n"),p=0;p<c.length;p++){var f=c[p];f=f.trim();var g;0!==f.length&&"#"!==f.charAt(0)&&(null!==(g=t.exec(f))?l.vertices.push([parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])]):null!==(g=i.exec(f))?l.normals.push([parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3])]):null!==(g=r.exec(f))?l.uvs.push([parseFloat(g[1]),parseFloat(g[2])]):null!==(g=n.exec(f))?d([g[1],g[2],g[3],g[4]]):null!==(g=a.exec(f))?d([g[2],g[5],g[8],g[11]],[g[3],g[6],g[9],g[12]]):null!==(g=o.exec(f))?d([g[2],g[6],g[10],g[14]],[g[3],g[7],g[11],g[15]],[g[4],g[8],g[12],g[16]]):null!==(g=s.exec(f))?d([g[2],g[5],g[8],g[11]],void 0,[g[3],g[6],g[9],g[12]]):/^o /.test(f)||/^g /.test(f)?(l.faces.length>0&&(l.faces=this.getCorrectIndices(l.faces)),l.faces.length>0&&h.push(l),l={},l.name=f.substring(2).trim(),l.vertices=[],l.normals=[],l.uvs=[],l.faces=[]):/^g /.test(f)||/^mtllib /.test(f)||(/^usemtl /.test(f)?u=f.substring(7).trim():/^s /.test(f)||console.log("VROne.OBJLoader: Unhandled line "+f)))}return h.length>0&&(l.faces=this.getCorrectIndices(l.faces)),h.push(l),h},getMtlName:function(e){for(var t=e.split("\n"),i=0;i<t.length;i++){var r=t[i];if(r=r.trim(),/^mtllib /.test(r))return r.substring(7).trim()}return null},readMtl:function(e){var t=e.split("\n"),i=/Kd ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+) ([\d|\.|\+|\-|e|E]+)/,r={},n=-1;r.mtlName=[],r.kd=[],r.mapKd=[];for(var a=0;a<t.length;a++){var o,s=t[a];/^newmtl /.test(s)?(n++,r.mtlName[n]=s.substring(7).trim()):null!==(o=i.exec(s))?r.kd[n]=[parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]),1]:/^map_Kd /.test(s)&&(r.mapKd[n]=s.substring(7).trim())}return r},getCorrectIndices:function(e){for(var t=parseInt(e[0][0][0]),i=parseInt(e[0][0][1]),r=parseInt(e[0][0][2]),n=0;n<e.length;n++)for(var a=0;3>a;a++)parseInt(e[n][a][0])<t&&(t=parseInt(e[n][a][0])),parseInt(e[n][a][1])<i&&(i=parseInt(e[n][a][1])),parseInt(e[n][a][2])<r&&(r=parseInt(e[n][a][2]));t-=1,i-=1,r-=1;for(var n=0;n<e.length;n++)for(var a=0;3>a;a++)e[n][a][0]-=t,e[n][a][1]-=i,e[n][a][2]-=r;return e},createO3DFromOBJ:function(e,t,i){var r=[],n=[],a=[],o=[],s=[],h=[],l=[],u=0,d=!t||t.mapKd.length>0,c=!t||d&&t.mapKd.length>1;console.log("New O3D:  "+3*e.faces.length);for(var p,f,g,p=0;p<e.faces.length;p++){var m,f=e.faces[p],x=0,v=!1;if(!t||0===t.kd.length&&0===t.mapKd.length)m=[.5,.5,.5,1];else{var R=t.mtlName.indexOf(f[3]);v=Boolean(t.mapKd[R]),m=v?t.mapKd[R]:t.kd[R],v&&(x=l.indexOf(m),0>x&&(l.push(m),x=l.indexOf(m)))}for(var g=0;3>g;g++){var V=f[g][0]-1,y=f[g][1]-1,O=f[g][2]-1,M=!1;M||(Array.prototype.push.apply(r,e.vertices[V]),Array.prototype.push.apply(s,e.normals[O]),v?(Array.prototype.push.apply(a,e.uvs[y]),Array.prototype.push.apply(n,[.5,.5,.5,2])):(Array.prototype.push.apply(n,m),Array.prototype.push.apply(a,[-1,-1])),o.push(x),h.push(u++))}}var w=new VROne.Object3D;if(r.length>0&&(w.vertices=r),n.length>0&&(w.colors=n),a.length>0&&(w.textureCoords=a),c&&(w.textureIndices=o),s.length>0&&(w.normals=s),h.length>0&&(w.indices=h),d){for(var p=0;p<l.length;p++)l[p]=i+l[p].replace(/\\/g,"/");if(l&&l.length>10)throw"OBJ Loader: Can't use more than 10 Textures";l.length>0&&(w.imageSrc=l)}return w}},VROne.Pyramid3D=function(){VROne.Object3D.call(this),this.vertices=[0,1,0,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],this.colors=[1,0,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5,0,1,0,.5],this.indices=[0,2,1,0,3,2,0,4,3,0,1,4,1,2,3,1,3,4],this.transparent=!0},VROne.Pyramid3D.prototype=VROne.Object3D.prototype,VROne.Cube3D=function(){VROne.Object3D.call(this),this.vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.colors=[1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,.5,.5,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},VROne.Cube3D.prototype=new VROne.Object3D,VROne.CubeTexture3D=function(){VROne.Object3D.call(this),this.imageSrc="nehe.gif",this.vertices=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5],this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],this.indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],this.calcBoundingBox()},VROne.CubeTexture3D.prototype=VROne.Object3D.prototype,VROne.CubeTexture3D_2=function(){VROne.CubeTexture3D.call(this),this.imageSrc="nehe2.gif",this.textureCoords=[1,0,1,.5,.5,.5,.5,0,0,.5,0,1,.5,1,.5,.5,.5,.5,.5,0,0,0,0,.5,1,0,1,.5,.5,.5,.5,0,.5,.5,.5,1,1,1,1,.5,1,.5,1,1,.5,1,.5,.5],this.normals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]},VROne.CubeTexture3D_2.prototype=VROne.CubeTexture3D.prototype,VROne.CubeTexture3D_3=function(){VROne.CubeTexture3D.call(this),this.imageSrc="transparent.png",this.transparent=!0},VROne.CubeTexture3D_3.prototype=new VROne.CubeTexture3D,VROne.CubeTexture3D_4=function(){VROne.CubeTexture3D_2.call(this),this.shininess=1,this.useFragmentLighting=!0,this.imageSrc="blue.png",this.transparent=!1,this.normalMap="blue-normal.png",this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]},VROne.CubeTexture3D_4.prototype=new VROne.CubeTexture3D_2,VROne.VRSquare=function(){VROne.Object3D.call(this),this.shader="vr-canvas",this.vertices=[-1,-1,1,1,-1,1,-1,1,1,1,1,1],this.textureCoords=[0,0,1,0,0,1,1,1],this.hasTexture=function(){return!0}},VROne.VRSquare.prototype=VROne.Object3D.prototype,VROne.ParticleSystem=function(e,t,i,r){VROne.Object3D.call(this);var n=3,a=3,o=3,s=1,h=1,l=1;this.particles=[];var u;for(u=0;i>u;u++)this.particles.push(new VROne.Particle);this.vertices=[],this.colors=null,this.textureCoords=null,this.indices=[],this.velocities=[],this.lifetimes=[],this.gravities=[],this.gravityExps=[],this.geometries=[],this.rotationAngles=[],this.normals=null,this.imageSrc=t.imageSrc,this.shader=null;var d={time:0,startTime:Date.now()};this.shaderAttributes=[],this.shaderAttributes.push(["aGeometryPosition",n,this.geometries]),this.shaderAttributes.push(["aVertexVelocity",a,this.velocities]),this.shaderAttributes.push(["aVertexRotation",o,this.rotationAngles]),this.shaderAttributes.push(["aLifetime",s,this.lifetimes]),this.shaderAttributes.push(["aGravity",h,this.gravities]),this.shaderAttributes.push(["aGravityExponent",l,this.gravityExps]),this.shaderUniforms=[],this.shaderUniforms.push(["uTime","uniform1f",d,["time"]]),this.initParticleArrays=function(){var e;for(u=0;u<this.particles.length;u++){var i=this.particles[u];for(e=0;e<t.vertices.length;e+=3)this.vertices.push(t.vertices[e]*i.scale.x+i.position.x),this.vertices.push(t.vertices[e+1]*i.scale.y+i.position.y),this.vertices.push(t.vertices[e+2]*i.scale.z+i.position.z),this.geometries.push(t.vertices[e]*i.scale.x),this.geometries.push(t.vertices[e+1]*i.scale.y),this.geometries.push(t.vertices[e+2]*i.scale.z)}if(t.textureCoords&&-1!=t.textureCoords[0])for(this.textureCoords=[],u=0;u<this.particles.length;u++)this.textureCoords=this.textureCoords.concat(t.textureCoords);else for(this.colors=[],u=0;u<this.particles.length;u++)this.colors=this.colors.concat(this.particles[u].colors?this.particles[u].colors:t.colors);for(u=0;u<this.particles.length;u++)for(e=0;e<t.indices.length;e++)this.indices.push(t.indices[e]+u*t.vertices.length/n);for(u=0;u<this.particles.length;u++)for(e=0;e<t.vertices.length/n;e++)t.velocities?(this.velocities.push(this.particles[u].velocity.x+t.velocities[e*a]),this.velocities.push(this.particles[u].velocity.y+t.velocities[e*a+1]),this.velocities.push(this.particles[u].velocity.z+t.velocities[e*a+2])):(this.velocities.push(this.particles[u].velocity.x),this.velocities.push(this.particles[u].velocity.y),this.velocities.push(this.particles[u].velocity.z));
for(u=0;u<this.particles.length;u++)for(e=0;e<t.vertices.length/n;e++)this.lifetimes.push(t.lifetimes?0===t.lifetimes[e]?this.particles[u].lifetime:Math.min(this.particles[u].lifetime,t.lifetimes[e]):this.particles[u].lifetime);for(u=0;u<this.particles.length;u++)for(e=0;e<t.vertices.length/n;e++)this.gravities.push(t.gravities?this.particles[u].gravity+t.gravities[e]:this.particles[u].gravity),this.gravityExps.push(this.particles[u].gravityExponent);for(u=0;u<this.particles.length;u++)for(e=0;e<t.vertices.length/n;e++)this.rotationAngles.push(this.particles[u].rotationAngle.x),this.rotationAngles.push(this.particles[u].rotationAngle.y),this.rotationAngles.push(this.particles[u].rotationAngle.z);if(t.normals)for(this.normals=[],u=0;u<this.particles.length;u++)this.normals=this.normals.concat(t.normals)};var c=this.update;this.update=function(){c.call(this),d.time=Date.now()+r-d.startTime}},VROne.ParticleSystem.prototype=new VROne.Object3D,VROne.Particle=function(){this.position=new VROne.Vector3(0,0,0),this.rotationAngle=new VROne.Vector3(0,0,0),this.scale=new VROne.Vector3(1,1,1),this.vertices=[],this.colors=null,this.velocity=new VROne.Vector3(0,0,0),this.lifetime=0,this.gravity=0,this.gravityExponent=1},VROne.Square=function(){VROne.Object3D.call(this),this.vertices=[-1,-1,0,1,-1,0,1,1,0,-1,1,0],this.colors=[0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],this.indices=[0,1,2,0,2,3]},VROne.Square.prototype=VROne.Object3D.prototype,VROne.Skybox=function(e,t,i,r,n,a,o,s,h){VROne.CubeTexture3D.call(this),this.isSkybox=!0,this.imageSrc=[o+e,o+t,o+i,o+r,o+n,o+a],this.parent=s,this.parentRotationWeight=new VROne.Vector3(0,0,0),this.parentPositionWeight=new VROne.Vector3(1,1,1);var l=2*h/Math.sqrt(3);this.scale=new VROne.Vector3(l,l,l),this.textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0],this.textureIndices=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5],this.normals=null,this.indices.reverse()},VROne.Skybox.prototype=VROne.CubeTexture3D.prototype,VROne.Sphere3D=function(){VROne.Object3D.call(this),this.imageSrc="earth.jpg",this.specularMap="earth-specular.gif",this.shininess=10,this.useFragmentLighting=!0;var e=30,t=30,i=5;this.vertices=[],this.normals=[],this.textureCoords=[];for(var r=0;e>=r;r++)for(var n=r*Math.PI/e,a=Math.sin(n),o=Math.cos(n),s=0;t>=s;s++){var h=2*s*Math.PI/t,l=Math.sin(h),u=Math.cos(h),d=u*a,c=o,p=l*a,f=1-s/t,g=1-r/e;this.normals.push(d),this.normals.push(c),this.normals.push(p),this.textureCoords.push(f),this.textureCoords.push(g),this.vertices.push(i*d),this.vertices.push(i*c),this.vertices.push(i*p)}for(console.log(this.normals),this.indices=[],r=0;e>r;r++)for(var s=0;t>s;s++){var m=r*(t+1)+s,x=m+t+1;this.indices.push(m+1),this.indices.push(x),this.indices.push(m),this.indices.push(m+1),this.indices.push(x+1),this.indices.push(x)}},VROne.Sphere3D.prototype=VROne.Object3D.prototype,VROne.KeyboardHandler=function(){var e=[],t=[];VROne.KeyboardHandler.keys=[],this.update=function(){var i;for(i=0;i<e.length;i++)VROne.KeyboardHandler.keys[e[i]]=!0,e.splice(i,1);for(i=0;i<t.length;i++)VROne.KeyboardHandler.keys[t[i]]=!1,t.splice(i,1)},window.addEventListener("keydown",function(t){var i=t.keyCode||t.which;VROne.KeyboardHandler.keys[i]||e.push(i)},!0),window.addEventListener("keyup",function(e){var i=e.keyCode||e.which;t.push(i)},!0)},VROne.KeyboardHandler.isKeyDown=function(e){if(!VROne.KeyboardHandler.keys)return void console.log("KeyboardHandler not initialised");if(e.length>1)throw"Only letter keys supported at the moment";var t=e.charCodeAt(0);return VROne.KeyboardHandler.keys[t]},VROne.KeyboardHandler.prototype={},VROne.GamepadHandler=function(){},VROne.GamepadHandler.getGamepads=function(){return APISupported?navigator.getGamepads():void 0};var APISupported=null,init=function(){navigator.getGamepads?(APISupported=!0,console.log("Gamepad API supported"),console.log("ongamepadconnected"in window?"ongamepadconnected supported":"ongamepadconnected not supported")):(APISupported=!1,console.log("Gamepad API not supported"))};init(),VROne.MouseHandler=function(){function e(){null!=document.pointerLockElement?document.addEventListener("mousemove",t.onMouseLockMove,!1):document.removeEventListener("mousemove",t.onMouseLockMove,!1)}var t=this;this.addedMovementX=0,this.addedMovementY=0,t.movementX=0,t.movementY=0,this.onMouseLockMove=function(e){t.addedMovementX+=e.movementX||e.mozMovementX||e.webkitMovementX||0,t.movementX=e.movementX||e.mozMovementX||e.webkitMovementX||0,t.addedMovementY+=e.movementY||e.mozMovementY||e.webkitMovementY||0,t.movementY=e.movementY||e.mozMovementY||e.webkitMovementY||0},document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1)};var mouseHandler=null,lastMovementX=0,lastMovementY=0,x=0,y=0;VROne.MouseHandler.getX=function(){return null===mouseHandler&&(mouseHandler=new VROne.MouseHandler),VROne.Scene.frameJustStarted&&(lastMovementX-mouseHandler.addedMovementX===0?x=0:(lastMovementX=mouseHandler.addedMovementX,x=mouseHandler.movementX)),x},VROne.MouseHandler.getY=function(){return null===mouseHandler&&(mouseHandler=new VROne.MouseHandler),VROne.Scene.frameJustStarted&&(lastMovementY-mouseHandler.addedMovementY===0?y=0:(lastMovementY=mouseHandler.addedMovementY,y=mouseHandler.movementY),VROne.Scene.frameJustStarted=!1),y},VROne.SensorsHandler=function(){var e=this;this.alpha=0,this.beta=0,this.gamma=0,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(t){e.alpha=t.alpha,e.beta=t.beta,e.gamma=t.gamma},!0)};var sensorsHandler=null;VROne.SensorsHandler.getRoll=function(){return null==sensorsHandler&&(sensorsHandler=new VROne.SensorsHandler),sensorsHandler.alpha},VROne.SensorsHandler.getPitch=function(){return null==sensorsHandler&&(sensorsHandler=new VROne.SensorsHandler),sensorsHandler.beta},VROne.SensorsHandler.getYaw=function(){return null==sensorsHandler&&(sensorsHandler=new VROne.SensorsHandler),sensorsHandler.gamma},VROne.SensorsHandler.prototype={},VROne.HMDHandler=function(){};var vrDevice=null,eyeParamsL=null,eyeParamsR=null,positionDevice=null,foundHMD=!1;VROne.HMDHandler.getHMDData=function(){return eyeParamsL&&eyeParamsR?[eyeParamsL,eyeParamsR]:null},VROne.HMDHandler.getPositionalData=function(){return null!==positionDevice?positionDevice.getState():void 0},VROne.HMDHandler.isPositionDevice=function(){return null===vrDevice&&null!==positionDevice?!0:null!==vrDevice&&null===positionDevice?!1:void 0},VROne.HMDHandler.resetSensor=function(){void 0!==positionDevice&&("resetSensor"in positionDevice?positionDevice.resetSensor():"zeroSensor"in positionDevice?positionDevice.zeroSensor():console.log("Can't reset position sensor."))};var onVRDevices=function(e){for(var t in e)e[t]instanceof HMDVRDevice&&null===vrDevice?(vrDevice=e[t],eyeParamsL=vrDevice.getEyeParameters("left"),eyeParamsR=vrDevice.getEyeParameters("right"),foundHMD=!0):e[t]instanceof PositionSensorVRDevice&&null===positionDevice&&(positionDevice=e[t])};void 0!==navigator.getVRDevices?navigator.getVRDevices().then(onVRDevices):console.log("Your browser is not WebVR Ready"),VROne.HMDHandler.isWebVRReady=function(){return void 0!==navigator.getVRDevices},VROne.HMDHandler.prototype={},VROne.CameraController=function(e){var t=this,i=new VROne.Vector3,r=new VROne.Quaternion;this.cameraProperties={vrDevice:null,eyeTranslationL:-.03,eyeTranslationR:.03,eyeFOVR:90,renderRectWidth:null,renderRectHeight:null},this.isInputVR=function(){for(n=0;n<this.devices.length;n++)if(this.devices[n]instanceof VROne.WebVR)return!0;return!1},this.devices=Array.isArray(e)?e:[e];var n,a=!this.isInputVR(),o=function(e){var i=e[0],r=e[1];t.cameraProperties.vrDevice=vrDevice,t.cameraProperties.eyeTranslationL=i.eyeTranslation.x,t.cameraProperties.eyeTranslationR=r.eyeTranslation.x,t.cameraProperties.eyeFOVL=i.recommendedFieldOfView,t.cameraProperties.eyeFOVR=r.recommendedFieldOfView;var n=i.renderRect,a=r.renderRect;t.cameraProperties.renderRectWidth=a.x+a.width,t.cameraProperties.renderRectHeight=Math.max(n.y+n.height,a.y+a.height)};this.update=function(){for(i.nullVector(),r.reset(),n=0;n<this.devices.length;n++){if(!a&&this.devices[n]instanceof VROne.WebVR){var e=this.devices[n].getHMDData();null!==e&&(o(e),a=!0)}r.multiply(r,this.devices[n].getOrientation());var t=this.devices[n].getPosition();i.add(t.x,t.y,t.z)}},this.getPosition=function(){return i},this.getOrientation=function(){return r}},VROne.CameraController.prototype={},VROne.DeviceConfig=function(){var e=new VROne.Vector3,t=new VROne.Quaternion;this.getOrientation=function(){return t},this.getPosition=function(){return e},this.getHMDData=function(){return null}},VROne.Cardboard=function(){VROne.DeviceConfig.call(this);var e=new VROne.Quaternion;this.getOrientation=function(){var t=VROne.EngineMath.degToRad(-VROne.SensorsHandler.getRoll()+180),i=VROne.EngineMath.degToRad(-VROne.SensorsHandler.getPitch()),r=VROne.EngineMath.degToRad(VROne.SensorsHandler.getYaw()+90),n=Math.cos(t/2),a=Math.cos(i/2),o=Math.cos(r/2),s=Math.sin(t/2),h=Math.sin(i/2),l=Math.sin(r/2);return e.x=s*h*o+n*a*l,e.y=s*a*o+n*h*l,e.z=-(n*h*o-s*a*l),e.w=n*a*o-s*h*l,e}},VROne.Cardboard.prototype=new VROne.DeviceConfig,VROne.WebVR=function(){var e=new VROne.Vector3,t=new VROne.Quaternion;this.getHMDData=function(){return VROne.HMDHandler.getHMDData()};var i=new VROne.Quaternion,r=new VROne.Vector3;this.update=function(n){VROne.KeyboardHandler.isKeyDown("R")&&VROne.HMDHandler.resetSensor();var a=VROne.HMDHandler.getPositionalData();a&&(e.x=a.position.x,e.y=a.position.y,e.z=a.position.z,e.w=a.position.w,t.x=a.orientation.x,t.y=a.orientation.y,t.z=a.orientation.z,t.w=a.orientation.w),e=i.multiply(n,t.getConjugate()).rotatePoint(r),t=t.getConjugate()},this.getPosition=function(){return e},this.getOrientation=function(){return t}},VROne.WebVR.prototype=new VROne.DeviceConfig,VROne.MouseKeyboard=function(e){var t=.2,i=new VROne.Vector3,r=new VROne.Quaternion;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;var n=new VROne.Vector3,a=Date.now(),o=new VROne.Quaternion,s=new VROne.Quaternion,h=new VROne.Vector3(1,0,0),l=new VROne.Vector3(0,1,0),u=0,d=0;this.update=function(e){var c=(Date.now()-a)/1e3,p=5,f=null;n.x=0,n.y=0,n.z=0,VROne.KeyboardHandler.isKeyDown("W")&&(f=n.add(0,0,-1)),VROne.KeyboardHandler.isKeyDown("S")&&(f=n.add(0,0,1)),VROne.KeyboardHandler.isKeyDown("D")&&(f=n.add(1,0,0)),VROne.KeyboardHandler.isKeyDown("A")&&(f=n.add(-1,0,0)),f&&(f=e.getRotatedPoint(f),i.add(f.x*p*c,f.y*p*c,f.z*p*c)),a=Date.now(),u+=VROne.MouseHandler.getX(),d+=VROne.MouseHandler.getY(),d*t>90?d=90/t:-90>d*t&&(d=-90/t),s.reset(),s.fromAxisAngle(l,u*t*Math.PI/180),o.reset(),o.fromAxisAngle(h,d*t*Math.PI/180),o.multiply(o,s),r=o},this.getPosition=function(){return i},this.getOrientation=function(){return r},e.onclick=function(){e.requestPointerLock()}},VROne.MouseKeyboard.prototype=new VROne.DeviceConfig,VROne.Gamepad=function(){var e=this;this.gamepads=[];var t,i=0,r=0,n=.3,a=6,o=3,s=new VROne.Vector3,h=new VROne.Vector3;this.getPosition=function(i){var r=.02;for(h.nullVector(),e.gamepads=VROne.GamepadHandler.getGamepads(),t=0;t<e.gamepads.length;t++)if(e.gamepads[t]){var o=0,l=0;(e.gamepads[t].axes[0]>n||e.gamepads[t].axes[0]<-n)&&(o=e.gamepads[t].axes[0]*a),(e.gamepads[t].axes[1]>n||e.gamepads[t].axes[1]<-n)&&(l=e.gamepads[t].axes[1]*a),h.add(o,0,l)}return h=i.getConjugate().getRotatedPoint(h),s.add(h.x*r,h.y*r,h.z*r),s};var l=new VROne.Quaternion,u=new VROne.Quaternion,d=new VROne.Vector3(1,0,0),c=new VROne.Vector3(0,1,0);this.getOrientation=function(){for(l.reset(),e.gamepads=VROne.GamepadHandler.getGamepads(),t=0;t<e.gamepads.length;t++)e.gamepads[t]&&((e.gamepads[t].axes[2]>n||e.gamepads[t].axes[2]<-n)&&(i+=e.gamepads[t].axes[2]*o),(e.gamepads[t].axes[3]>n||e.gamepads[t].axes[3]<-n)&&(r+=e.gamepads[t].axes[3]*o),u.reset(),u.fromAxisAngle(c,i*Math.PI/180),l.reset(),l.fromAxisAngle(d,r*Math.PI/180),l.multiply(l,u));return l}},VROne.Gamepad.prototype=new VROne.DeviceConfig,VROne.Websocket=function(e,t){var i=this,r=!1,n=new WebSocket("ws://"+e+":"+t),a=new FileReader;n.onopen=function(){r=!0,console.log("connected websocket to "+e+":"+t)},n.onclose=function(){r=!1,console.log("disconnected websocket from "+e+":"+t)},n.onmessage=function(e){a.readyState!=a.LOADING&&a.readAsArrayBuffer(e.data)},n.onerror=function(e){console.log("Websocket error: "+e.data)},a.addEventListener("loadend",function(){var e=a.result,t=new DataView(e),r=t.getUint8(0);e=e.slice(1),i.onReceive(r,e)}),this.onReceive=function(e,t){console.log(e+", "+t.byteLength)},this.send=function(e){n.send(e)},this.close=function(){n.close()},this.isConnected=function(){return r}},VROne.Websocket.prototype={};